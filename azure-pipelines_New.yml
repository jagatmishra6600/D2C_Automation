# Azure Pipelines configuration for D2C_Automation
# Runs every 2 hours via scheduled trigger and executes Maven tests.

name: $(Date:yyyyMMdd-HHmm)

trigger: none
pr: none

schedules:
  - cron: "0 */2 * * *"   # Every 2 hours at minute 0 (UTC)
    displayName: "Every 2 hours"
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'windows-latest'

variables:
  projectDir: 'D2C_Automation'
  allureResultsDir: '$(projectDir)/allure-results'
  allureReportDir: '$(projectDir)/allure-report'

steps:
  # ---------------------------------------------------------
  # 1Ô∏è‚É£ Setup Java Environment
  # ---------------------------------------------------------
  - task: JavaToolInstaller@0
    displayName: 'Use Java 17'
    inputs:
      versionSpec: '17'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'

  # ---------------------------------------------------------
  # 2Ô∏è‚É£ Build and Test using Maven
  # ---------------------------------------------------------
  - task: Maven@3
    displayName: 'Build and Test (Maven)'
    inputs:
      mavenPomFile: '$(projectDir)/pom.xml'
      goals: 'clean test'
      options: '-B'
      publishJUnitResults: true
      testResultsFiles: '**/surefire-reports/*.xml'
      codeCoverageToolOption: 'JaCoCo'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.17'
      jdkArchitectureOption: 'x64'

  # ---------------------------------------------------------
  # 3Ô∏è‚É£ Publish Test Results Summary
  # ---------------------------------------------------------
  - task: PublishTestResults@2
    displayName: 'Publish Test Results Summary'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '$(projectDir)/target/surefire-reports/TEST-*.xml'
      testRunTitle: 'Maven Tests'
      mergeTestResults: true
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 4Ô∏è‚É£ Publish Code Coverage
  # ---------------------------------------------------------
  - task: PublishCodeCoverageResults@2
    displayName: 'Publish Code Coverage (JaCoCo)'
    inputs:
      codeCoverageTool: 'JaCoCo'
      summaryFileLocation: '$(projectDir)/target/site/jacoco/jacoco.xml'
      reportDirectory: '$(projectDir)/target/site/jacoco'
      failIfCoverageEmpty: false
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 5Ô∏è‚É£ Generate and Publish Allure Report
  # ---------------------------------------------------------
  - script: |
      echo "==== Generating Allure Report ===="
      npm install -g allure-commandline --force
      allure generate $(allureResultsDir) --clean -o $(allureReportDir)
    displayName: 'Generate Allure Report'
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Report'
    inputs:
      PathtoPublish: '$(allureReportDir)'
      ArtifactName: 'allure-report'
      publishLocation: 'Container'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 6Ô∏è‚É£ Publish Extent Report
  # ---------------------------------------------------------
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Extent Report Artifact'
    inputs:
      PathtoPublish: '$(projectDir)/test-output'
      ArtifactName: 'extent-report'
      publishLocation: 'Container'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 7Ô∏è‚É£ Applitools Visual Tests
  # ---------------------------------------------------------
  - script: |
      echo "Running Applitools Eyes Tests..."
      npx eyes-storybook -u https://eyes.applitools.com
    displayName: 'Run Applitools Visual Tests'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 8Ô∏è‚É£ Aqua Security Scans (Container + Serverless)
  # ---------------------------------------------------------
  - script: |
      echo "Running Aqua Trivy Container Scan..."
      trivy fs --format sarif -o $(Build.ArtifactStagingDirectory)/aqua-container.sarif $(projectDir)
    displayName: 'Aqua Container Scanner Report'
    condition: succeededOrFailed()

  - script: |
      echo "Running Aqua Serverless Scan..."
      trivy config --format sarif -o $(Build.ArtifactStagingDirectory)/aqua-serverless.sarif $(projectDir)
    displayName: 'Aqua Serverless Scanner Report'
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Aqua Scan Reports'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'aqua-scans'
      publishLocation: 'Container'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 9Ô∏è‚É£ Black Duck Risk Report
  # ---------------------------------------------------------
  - script: |
      echo "Running Black Duck Scan..."
      bash <(curl -s https://detect.synopsys.com/detect.sh) \
        --blackduck.url=$(BLACKDUCK_URL) \
        --blackduck.api.token=$(BLACKDUCK_TOKEN) \
        --detect.project.name="D2C_Automation" \
        --detect.project.version.name="build-$(Build.BuildNumber)"
    displayName: 'Black Duck Risk Report'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # üîü Qualys WAS Scan
  # ---------------------------------------------------------
  - script: |
      echo "Running Qualys WAS Scan..."
      # Placeholder for Qualys API command
    displayName: 'Qualys WAS Scan Status'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 1Ô∏è‚É£1Ô∏è‚É£ Sauce Labs Integration
  # ---------------------------------------------------------
  - script: |
      echo "Running tests on Sauce Labs..."
      mvn test -Dsauce.username=$(SAUCE_USERNAME) -Dsauce.accessKey=$(SAUCE_ACCESS_KEY)
    displayName: 'Run Sauce Labs Tests'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 1Ô∏è‚É£2Ô∏è‚É£ Mend Bolt (Dependency Risk)
  # ---------------------------------------------------------
  - task: MendBolt@1
    displayName: 'Mend Bolt Scan'
    inputs:
      apiToken: '$(MEND_BOLT_TOKEN)'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 1Ô∏è‚É£3Ô∏è‚É£ Artifactory Publish (Builds / Dependencies)
  # ---------------------------------------------------------
  - task: ArtifactoryGenericUpload@2
    displayName: 'Upload Artifacts to Artifactory'
    inputs:
      artifactoryService: 'ArtifactoryServiceConnection'
      specSource: 'file'
      file: '$(projectDir)/upload-spec.json'
      failNoOp: true
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 1Ô∏è‚É£4Ô∏è‚É£ Publish Screenshots
  # ---------------------------------------------------------
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Screenshots'
    inputs:
      PathtoPublish: '$(projectDir)/screenshots'
      ArtifactName: 'screenshots'
      publishLocation: 'Container'
    condition: succeededOrFailed()

  # ---------------------------------------------------------
  # 1Ô∏è‚É£5Ô∏è‚É£ Pipeline Summary
  # ---------------------------------------------------------
  - script: |
      echo "=============================="
      echo "‚úÖ TESTS SUMMARY"
      echo "‚úÖ CODE COVERAGE"
      echo "‚úÖ APPLITOOLS"
      echo "‚úÖ AQUA SCAN REPORTS"
      echo "‚úÖ BLACK DUCK RISK REPORT"
      echo "‚úÖ ALLURE REPORT"
      echo "‚úÖ ARTIFACTORY UPLOADS"
      echo "‚úÖ QUALYS WAS SCAN"
      echo "‚úÖ SAUCE LABS TESTS"
      echo "‚úÖ MEND BOLT SCAN"
      echo "=============================="
    displayName: 'Show Summary'
    condition: always()
