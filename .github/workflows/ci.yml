name: D2C Automation CI

on:
  schedule:
    - cron: "30 2 * * *"  # Daily at 2:30 AM UTC
  workflow_dispatch:

jobs:
  D2C_Automation_Job:
    name: Run D2C Automation Suite (Windows)
    runs-on: windows-latest
    timeout-minutes: 180

    env:
      BRAND: frigidaire
      HEADLESS: true
      MAVEN_OPTS: "-Xmx2g -Djansi.force=true -Dorg.slf4j.simpleLogger.defaultLogLevel=DEBUG"
      CI: true

    steps:
      # ----------------------------------------------------------
      # Checkout repository
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # ----------------------------------------------------------
      # Initial Setup and Welcome
      # ----------------------------------------------------------
      - name: Welcome and Initial Setup
        run: |
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "üöÄ D2C AUTOMATION SUITE - REAL-TIME EXECUTION" -ForegroundColor Yellow
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "üìÖ Date: $(Get-Date -Format 'yyyy-MM-dd')" -ForegroundColor White
          Write-Host "‚è∞ Start Time: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor White
          Write-Host "üîß Run ID: ${{ github.run_id }}" -ForegroundColor White
          Write-Host "üîÑ Attempt: ${{ github.run_attempt }}" -ForegroundColor White
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host ""

      # ----------------------------------------------------------
      # System Information
      # ----------------------------------------------------------
      - name: System Diagnostics
        run: |
          Write-Host "üñ•Ô∏è SYSTEM DIAGNOSTICS" -ForegroundColor Green
          Write-Host "-------------------" -ForegroundColor Green
          
          Write-Host "üìä Memory Information:" -ForegroundColor Yellow
          systeminfo | findstr /C:"Total Physical Memory" /C:"Available Physical Memory"
          
          Write-Host "üíæ Disk Space:" -ForegroundColor Yellow
          Get-PSDrive C | Format-Table Name, @{Name="Size(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Total(GB)";Expression={[math]::Round(($_.Used + $_.Free)/1GB,2)}} -AutoSize
          
          Write-Host "‚ö° CPU Information:" -ForegroundColor Yellow
          Get-WmiObject Win32_Processor | Select-Object Name, NumberOfCores, MaxClockSpeed | Format-Table -AutoSize
          
          Write-Host ""

      # ----------------------------------------------------------
      # Deep Cleanup with Real-time Output
      # ----------------------------------------------------------
      - name: Deep Cleanup Before Tests
        run: |
          Write-Host "üßπ DEEP CLEANUP PROCESS" -ForegroundColor Magenta
          Write-Host "======================" -ForegroundColor Magenta
          
          Write-Host "üìä Memory before cleanup:" -ForegroundColor Cyan
          $memoryBefore = systeminfo | findstr "Available Physical Memory"
          Write-Host "   $memoryBefore"
          
          Write-Host "üî™ Terminating existing processes..." -ForegroundColor Red
          $processes = @("chrome", "chromedriver", "java", "msedgedriver", "geckodriver")
          foreach ($process in $processes) {
            $killed = taskkill /F /IM "$process.exe" 2>$null
            if ($LASTEXITCODE -eq 0) {
              Write-Host "   ‚úÖ Killed $process.exe" -ForegroundColor Green
            }
          }
          
          Write-Host "üóëÔ∏è Cleaning temporary files..." -ForegroundColor Yellow
          $tempPaths = @("$env:TEMP", "C:\Windows\Temp", "${{ github.workspace }}\target")
          foreach ($path in $tempPaths) {
            if (Test-Path $path) {
              Remove-Item -Path "$path\*" -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "   ‚úÖ Cleaned $path" -ForegroundColor Green
            }
          }
          
          Write-Host "üßπ Clearing Maven cache..." -ForegroundColor Yellow
          if (Test-Path "~\.m2\repository") {
            Remove-Item -Path "~\.m2\repository\*" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   ‚úÖ Maven cache cleared" -ForegroundColor Green
          }
          
          Write-Host "üìä Memory after cleanup:" -ForegroundColor Cyan
          $memoryAfter = systeminfo | findstr "Available Physical Memory"
          Write-Host "   $memoryAfter"
          Write-Host "‚úÖ Cleanup completed successfully!" -ForegroundColor Green
          Write-Host ""

      # ----------------------------------------------------------
      # Browser Setup with Detailed Output
      # ----------------------------------------------------------
      - name: Browser Environment Setup
        run: |
          Write-Host "üåê BROWSER ENVIRONMENT SETUP" -ForegroundColor Blue
          Write-Host "==========================" -ForegroundColor Blue
          
          Write-Host "üîç Checking Chrome installation..." -ForegroundColor Cyan
          $chromePaths = @(
            "C:\Program Files\Google\Chrome\Application\chrome.exe",
            "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
          )
          
          $chromeInstalled = $false
          foreach ($path in $chromePaths) {
            if (Test-Path $path) {
              $version = & "$path" --version
              Write-Host "   ‚úÖ Chrome found: $version" -ForegroundColor Green
              Write-Host "   üìç Location: $path" -ForegroundColor White
              $chromeInstalled = $true
              break
            }
          }
          
          if (-not $chromeInstalled) {
            Write-Host "   üöÄ Installing Google Chrome..." -ForegroundColor Yellow
            $installer = "chrome_installer.exe"
            Write-Host "   üì• Downloading Chrome installer..." -ForegroundColor White
            Invoke-WebRequest "https://dl.google.com/chrome/install/375.126/chrome_installer.exe" -OutFile $installer
            Write-Host "   üîß Installing Chrome (silent mode)..." -ForegroundColor White
            Start-Process -FilePath $installer -Args "/silent /install" -Wait
            Remove-Item $installer
            Write-Host "   ‚úÖ Chrome installed successfully" -ForegroundColor Green
          }
          Write-Host ""

      # ----------------------------------------------------------
      # ChromeDriver Setup
      # ----------------------------------------------------------
      - name: ChromeDriver Installation
        run: |
          Write-Host "üîß CHROMEDRIVER SETUP" -ForegroundColor Blue
          Write-Host "====================" -ForegroundColor Blue
          
          Write-Host "üîç Detecting Chrome version..." -ForegroundColor Cyan
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
            $versionInfo = (Get-Item $chromePath).VersionInfo
            $chromeVersion = "$($versionInfo.FileMajorPart).$($versionInfo.FileMinorPart).$($versionInfo.FileBuildPart).$($versionInfo.FilePrivatePart)"
            $majorVersion = $versionInfo.FileMajorPart
            Write-Host "   üìã Chrome Version: $chromeVersion" -ForegroundColor White
            Write-Host "   üî¢ Major Version: $majorVersion" -ForegroundColor White
          
            Write-Host "üì• Downloading matching ChromeDriver..." -ForegroundColor Cyan
            $chromedriverUrl = "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$chromeVersion/win64/chromedriver-win64.zip"
            Write-Host "   üîó URL: $chromedriverUrl" -ForegroundColor Gray
          
            $zipFile = "chromedriver.zip"
            try {
              Invoke-WebRequest $chromedriverUrl -OutFile $zipFile -UserAgent "Mozilla/5.0"
              Write-Host "   ‚úÖ ChromeDriver downloaded successfully" -ForegroundColor Green
          
              Write-Host "üì¶ Extracting ChromeDriver..." -ForegroundColor Cyan
              Expand-Archive -Path $zipFile -DestinationPath ".\chromedriver" -Force
          
              Write-Host "üîß Installing ChromeDriver to system path..." -ForegroundColor Cyan
              Move-Item -Path ".\chromedriver\chromedriver-win64\chromedriver.exe" -Destination "C:\Windows\System32\chromedriver.exe" -Force
          
              Write-Host "üßπ Cleaning up temporary files..." -ForegroundColor Yellow
              Remove-Item $zipFile -Force
              Remove-Item -Path ".\chromedriver" -Recurse -Force
          
              Write-Host "‚úÖ ChromeDriver installation completed!" -ForegroundColor Green
          
              # Verify installation
              $chromedriverVersion = & "chromedriver" --version
              Write-Host "   üîç ChromeDriver Version: $chromedriverVersion" -ForegroundColor White
          
            } catch {
              Write-Host "   ‚ùå Failed to download ChromeDriver: $($_.Exception.Message)" -ForegroundColor Red
              Write-Host "   üîÑ Attempting to use system ChromeDriver..." -ForegroundColor Yellow
            }
          } else {
            Write-Host "   ‚ùå Chrome not found after installation attempt" -ForegroundColor Red
          }
          Write-Host ""

      # ----------------------------------------------------------
      # Java Setup
      # ----------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify Java Installation
        run: |
          Write-Host "‚òï JAVA VERIFICATION" -ForegroundColor DarkMagenta
          Write-Host "==================" -ForegroundColor DarkMagenta
          Write-Host "üîç Java Version:" -ForegroundColor Cyan
          java -version
          Write-Host "üîç Java Compiler Version:" -ForegroundColor Cyan
          javac -version
          Write-Host "‚úÖ Java environment ready!" -ForegroundColor Green
          Write-Host ""

      # ----------------------------------------------------------
      # Pre-Test Configuration
      # ----------------------------------------------------------
      - name: Pre-Test Configuration
        run: |
          Write-Host "‚öôÔ∏è PRE-TEST CONFIGURATION" -ForegroundColor DarkCyan
          Write-Host "======================" -ForegroundColor DarkCyan
          Write-Host "üè∑Ô∏è Brand: ${{ env.BRAND }}" -ForegroundColor White
          Write-Host "üåê Headless Mode: ${{ env.HEADLESS }}" -ForegroundColor White
          Write-Host "üíæ Maven Options: ${{ env.MAVEN_OPTS }}" -ForegroundColor White
          Write-Host "üìÅ Workspace: ${{ github.workspace }}" -ForegroundColor White
          Write-Host "‚úÖ Configuration completed!" -ForegroundColor Green
          Write-Host ""

      # ----------------------------------------------------------
      # REAL-TIME TEST EXECUTION
      # ----------------------------------------------------------
      - name: Execute Test Suite - Real Time
        run: |
          Write-Host "üéØ TEST EXECUTION STARTED" -ForegroundColor Green -BackgroundColor Black
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "‚è∞ Execution Start: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor Cyan
          Write-Host "üìù Test Suite: D2C Automation" -ForegroundColor Cyan
          Write-Host "üè∑Ô∏è Brand: ${{ env.BRAND }}" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üìã MAVEN TEST OUTPUT (REAL-TIME):" -ForegroundColor Yellow
          Write-Host "----------------------------------------" -ForegroundColor Yellow
          
          # Set environment for real-time output
          $env:MAVEN_OPTS = "${{ env.MAVEN_OPTS }} -Dstyle.color=always"
          
          # Execute tests with maximum verbosity and real-time output
          mvn clean test `
            --batch-mode `
            --no-transfer-progress `
            -T 1 `
            -e `  # Stack trace on error
            -X `  # Debug output
            -Dmaven.test.redirectTestOutputToFile=false `
            -Dbrand=${{ env.BRAND }} `
            -Dwebdriver.chrome.verboseLogging=true `
            -Dwebdriver.chrome.logfile="${{ github.workspace }}\target\chromedriver.log" `
            -Dmaven.surefire.printSummary=true `
            -Dmaven.test.force.stdout=true `
            -Dmaven.test.force.ansi=true `
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer=DEBUG `
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.lifecycle=DEBUG `
            -Dsurefire.printSummary=true `
            -Dsurefire.useFile=false
          
          $testExitCode = $LASTEXITCODE
          Write-Host ""
          Write-Host "----------------------------------------" -ForegroundColor Yellow
          Write-Host "‚è∞ Execution End: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor Cyan
          Write-Host "üéØ TEST EXECUTION COMPLETED" -ForegroundColor Green -BackgroundColor Black
          Write-Host ""

      # ----------------------------------------------------------
      # Post-Test Analysis
      # ----------------------------------------------------------
      - name: Post-Test Analysis
        if: always()
        run: |
          Write-Host "üìä POST-TEST ANALYSIS" -ForegroundColor Magenta
          Write-Host "===================" -ForegroundColor Magenta
          
          # Check for test results
          $surefirePath = "${{ github.workspace }}\target\surefire-reports"
          $extentPath = "${{ github.workspace }}\test-output"
          $chromedriverLogPath = "${{ github.workspace }}\target\chromedriver.log"
          
          Write-Host "üîç Checking generated reports..." -ForegroundColor Cyan
          
          if (Test-Path $surefirePath) {
            $testFiles = Get-ChildItem "$surefirePath\*.txt" | Measure-Object
            $xmlFiles = Get-ChildItem "$surefirePath\*.xml" | Measure-Object
            Write-Host "   ‚úÖ Surefire Reports: $($testFiles.Count) text files, $($xmlFiles.Count) XML files" -ForegroundColor Green
          } else {
            Write-Host "   ‚ùå Surefire Reports: Not found" -ForegroundColor Red
          }
          
          if (Test-Path $extentPath) {
            $extentFiles = Get-ChildItem $extentPath -Recurse | Measure-Object
            Write-Host "   ‚úÖ Extent Reports: $($extentFiles.Count) files" -ForegroundColor Green
          } else {
            Write-Host "   ‚ùå Extent Reports: Not found" -ForegroundColor Red
          }
          
          if (Test-Path $chromedriverLogPath) {
            $logSize = (Get-Item $chromedriverLogPath).Length / 1KB
            Write-Host "   ‚úÖ ChromeDriver Log: $([math]::Round($logSize, 2)) KB" -ForegroundColor Green
          } else {
            Write-Host "   ‚ùå ChromeDriver Log: Not found" -ForegroundColor Red
          }
          Write-Host ""

      # ----------------------------------------------------------
      # Upload Test Reports
      # ----------------------------------------------------------
      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-${{ github.run_id }}-${{ github.run_attempt }}
          path: target/surefire-reports
          retention-days: 30

      - name: Upload Extent Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-reports-${{ github.run_id }}-${{ github.run_attempt }}
          path: test-output
          retention-days: 30

      - name: Upload ChromeDriver Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chromedriver-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: target/chromedriver.log
          retention-days: 30

      - name: Upload Maven Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            **/maven-*.log
            **/surefire-*.log
          retention-days: 30

      # ----------------------------------------------------------
      # Final Summary
      # ----------------------------------------------------------
      - name: Execution Summary
        if: always()
        run: |
          Write-Host "üéâ EXECUTION SUMMARY" -ForegroundColor Cyan
          Write-Host "==================" -ForegroundColor Cyan
          Write-Host "üìÖ Date: $(Get-Date -Format 'yyyy-MM-dd')" -ForegroundColor White
          Write-Host "‚è∞ Start Time: ${{ job.steps[1].outputs.start-time }}" -ForegroundColor White
          Write-Host "‚è±Ô∏è End Time: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor White
          Write-Host "üîß Run ID: ${{ github.run_id }}" -ForegroundColor White
          Write-Host "üîÑ Attempt: ${{ github.run_attempt }}" -ForegroundColor White
          Write-Host "üìä Status: ${{ job.status }}" -ForegroundColor $(if (${{ job.status }} -eq 'success') { 'Green' } else { 'Red' })
          Write-Host "üìÅ Artifacts: 4 sets uploaded" -ForegroundColor White
          Write-Host ""
          
          if (${{ job.status }} -eq 'success') {
            Write-Host "‚úÖ üéâ ALL TESTS COMPLETED SUCCESSFULLY! üéâ ‚úÖ" -ForegroundColor Green -BackgroundColor Black
          } else {
            Write-Host "‚ùå üìù SOME TESTS FAILED - CHECK REPORTS FOR DETAILS üìù ‚ùå" -ForegroundColor Red -BackgroundColor Black
          }
          
          Write-Host ""
          Write-Host "üîç Next steps:" -ForegroundColor Yellow
          Write-Host "   1. Download artifacts from the Actions tab" -ForegroundColor White
          Write-Host "   2. Review test reports in surefire-reports" -ForegroundColor White
          Write-Host "   3. Check detailed logs in uploaded artifacts" -ForegroundColor White
          Write-Host "   4. View Extent Reports for visual test results" -ForegroundColor White
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Cyan